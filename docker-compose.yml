version: "3.9"
services:
  # --- Існуючі сервіси (оновлені depends_on) ---
  user_service:
    build: ./user_service
    environment:
      - PYTHONUNBUFFERED=1
    restart: always

  product_service:
    build: ./product_service
    depends_on:
      - rabbitmq
    environment:
      - PYTHONUNBUFFERED=1
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: always

  order_service:
    build: ./order_service
    depends_on: 
      - user_service
      - product_service
      - rabbitmq
    environment:
      - PYTHONUNBUFFERED=1
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: always
    command: >
     sh -c "python db.py && python app.py & python outbox_worker.py & python saga_orchestrator.py"

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"

  # --- НОВІ СЕРВІСИ ДЛЯ ЛР5 ---
  
  # API Gateway
  nginx:
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - user_service
      - product_service
      - order_service

  # Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.0
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres_auth:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    depends_on:
      - postgres_auth

  postgres_auth:
    image: postgres:15
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    volumes:
      - auth_data:/var/lib/postgresql/data

volumes:
  auth_data: